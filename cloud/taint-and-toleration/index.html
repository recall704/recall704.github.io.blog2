<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>k8s 中的污染 Taint 与容忍 Toleration</title>
  <meta property="og:title" content="k8s 中的污染 Taint 与容忍 Toleration" />
  <meta name="twitter:title" content="k8s 中的污染 Taint 与容忍 Toleration" />
  <meta name="description" content="之前的内部分享中我提到过，pod 最终会被调度到某个具体的 node 上运行。那么有没有某种方式，限制 pod，不让它在某些 node 上运行呢？ 或者说，只允许某些 pod 在某些 node 上运行呢？  taint 和 toleration 了解一下。
 一、 taint （污染） 首先一点，taint 是针对 node 而言的，给 node 增加 taint 的命令如下
kubectl taint nodes node1 aaa=bbb:NoSchedule  其中：
1. aaa 代表 taint 的 key
2. bbb 代表 taint 的 value
3. NoSchedule 代码这个 taint 对应的影响，它可以有三个值
   值 含义     NoSchedule 不允许新的 pod 调度到该 node 上，除非 toleration 条件满足；不影响已经运行在该 node 上的 pod   PreferNoSchedule 尽可能不要调度到该 node 上，除非 toleration 条件满足；不影响已经运行在该 node 上的 pod   NoExecute 驱逐该节点上的 pod 到其它节点，除了 toleration 条件满足的 pod；影响已经运行在该 node 上的所有 pod    我们了解到一点，那就是增加了 taint 的 node，pod 就不会调度到它上面运行了。">
  <meta property="og:description" content="之前的内部分享中我提到过，pod 最终会被调度到某个具体的 node 上运行。那么有没有某种方式，限制 pod，不让它在某些 node 上运行呢？ 或者说，只允许某些 pod 在某些 node 上运行呢？  taint 和 toleration 了解一下。
 一、 taint （污染） 首先一点，taint 是针对 node 而言的，给 node 增加 taint 的命令如下
kubectl taint nodes node1 aaa=bbb:NoSchedule  其中：
1. aaa 代表 taint 的 key
2. bbb 代表 taint 的 value
3. NoSchedule 代码这个 taint 对应的影响，它可以有三个值
   值 含义     NoSchedule 不允许新的 pod 调度到该 node 上，除非 toleration 条件满足；不影响已经运行在该 node 上的 pod   PreferNoSchedule 尽可能不要调度到该 node 上，除非 toleration 条件满足；不影响已经运行在该 node 上的 pod   NoExecute 驱逐该节点上的 pod 到其它节点，除了 toleration 条件满足的 pod；影响已经运行在该 node 上的所有 pod    我们了解到一点，那就是增加了 taint 的 node，pod 就不会调度到它上面运行了。">
  <meta name="twitter:description" content="之前的内部分享中我提到过，pod 最终会被调度到某个具体的 node 上运行。那么有没有某种方式，限制 pod，不让它在某些 node 上运行呢？ 或者说，只允许某些 pod 在某些 node 上运行呢？  taint 和 toleration 了解一下。
 一、 taint （污染） 首先一点，taint 是针对 node 而言的，给 node 增加 taint 的命令如下
kubectl …">
  <meta name="author" content=""/>
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="http://www.recall704.com/cloud/taint-and-toleration/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="RECALL&#39;s Blog" />

  <meta name="generator" content="Hugo 0.32.2" />
  <link rel="canonical" href="http://www.recall704.com/cloud/taint-and-toleration/" />
  <link rel="alternate" href="http://www.recall704.com/index.xml" type="application/rss+xml" title="RECALL&#39;s Blog">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://www.recall704.com/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://www.recall704.com/css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://www.recall704.com/css/highlight.min.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.recall704.com/">RECALL&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="home" href="/">home</a>
            </li>
          
        
          
            <li>
              <a title="tags" href="/tags/">tags</a>
            </li>
          
        
          
            <li>
              <a title="categories" href="/categories/">categories</a>
            </li>
          
        
          
            <li>
              <a title="series" href="/series/">series</a>
            </li>
          
        
          
            <li>
              <a title="about" href="/about/">about</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>k8s 中的污染 Taint 与容忍 Toleration</h1>
                
                
                  <span class="post-meta">
  Posted on March 11, 2018
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      <hr />
      

      

      <article role="main" class="blog-post">
        

<p>之前的内部分享中我提到过，pod 最终会被调度到某个具体的 node 上运行。那么有没有某种方式，限制 pod，不让它在某些 node 上运行呢？ 或者说，只允许某些 pod 在某些 node 上运行呢？
<img src="/static/images/15208671290222.jpg" alt="" /></p>

<blockquote>
<p>taint 和 toleration 了解一下。</p>
</blockquote>

<h2 id="一-taint-污染">一、 taint （污染）</h2>

<p>首先一点，taint 是针对 node 而言的，给 node 增加 taint 的命令如下</p>

<pre><code>kubectl taint nodes node1 aaa=bbb:NoSchedule
</code></pre>

<p>其中：<br />
1. aaa 代表 taint 的 key<br />
2. bbb 代表 taint 的 value<br />
3. NoSchedule 代码这个 taint 对应的影响，它可以有三个值</p>

<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>

<tbody>
<tr>
<td>NoSchedule</td>
<td>不允许新的 pod 调度到该 node 上，除非 toleration 条件满足；不影响已经运行在该 node 上的 pod</td>
</tr>

<tr>
<td>PreferNoSchedule</td>
<td>尽可能不要调度到该 node 上，除非 toleration 条件满足；不影响已经运行在该 node 上的 pod</td>
</tr>

<tr>
<td>NoExecute</td>
<td>驱逐该节点上的 pod 到其它节点，除了 toleration 条件满足的 pod；影响已经运行在该 node 上的所有 pod</td>
</tr>
</tbody>
</table>

<p>我们了解到一点，那就是增加了 taint 的 node，pod 就不会调度到它上面运行了。</p>

<h2 id="二-toleration-容忍">二、toleration （容忍）</h2>

<p>同样的，toleration 是对 pod 而言的。<br />
在上面我们给 node 增加 taint，pod 已经不会调度到上面了，那么如果我们想把需要的 pod 运行在这个 node 上，我们怎么做呢？
答案就是： <strong>给 pod 增加 toleration，容忍 node 上添加的 taint 条件。</strong></p>

<pre><code>tolerations:
- key: &quot;aaa&quot;
  operator: &quot;Equal&quot;
  value: &quot;bbb&quot;
  effect: &quot;NoSchedule&quot;
</code></pre>

<table>
<thead>
<tr>
<th>operator 值</th>
<th>含义</th>
</tr>
</thead>

<tbody>
<tr>
<td>Equal</td>
<td>只有 key-value 都和 taint 一致，才算满足容忍条件，pod 才能跑在上面</td>
</tr>

<tr>
<td>Exists</td>
<td>只要 key 存在，就算满足容忍条件，value 可以为空</td>
</tr>
</tbody>
</table>

<h2 id="三-常用使用案例">三、常用使用案例</h2>

<p>说了这么多，这个 taint 和 toleration 到底有什么用呢？</p>

<h4 id="1-保证-master-的稳定性">1. 保证 master 的稳定性：</h4>

<p>为了保证 master 节点的稳定性，我们尽可能不让 pod 运行在上面，除了必须的 pod （比如 <code>日志 agent</code> 和 <code>监控 agent</code>）。
我们给 master01 增加 taint</p>

<pre><code>kubectl taint nodes master01 node-master=true:NoSchedule
</code></pre>

<p>我们给 <code>日志 agent</code> 和 <code>监控 agent</code> 增加对应的 toleration</p>

<pre><code>tolerations:
- key: &quot;node-master&quot;
  operator: &quot;Equal&quot;
  value: &quot;true&quot;
  effect: &quot;NoSchedule&quot;
</code></pre>

<p>这样，master 上就会只运行这些必须的 pod，而不会运行其它应用的 pod 了。</p>

<h4 id="2-节点升级维护">2. 节点升级维护：</h4>

<p>当节点需要维护时，可以给节点增加 taint 且 effect 的值为 NoExecute，由于没有对应的 toleration 存在，pod 会被驱逐到其它节点运行，这个时候我们就可以对这个节点进行维护了。</p>

<h2 id="四-常见问题">四、常见问题</h2>

<p>Q：taint 会影响到 daemonset 吗？<br />
A：会，taint 是针对所有 pod 的，daemonset 最终也会生成对应的 pod，所以 daemonset 配置的时候需要设置对应的 toleration。</p>

<p>Q: 如何删除 taint<br />
A: <code>kubectl taint nodes node1 key:NoSchedule-</code></p>

      </article>



      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="http://www.recall704.com/cloud/fix-alpine-update-failed/" data-toggle="tooltip" data-placement="top" title="Fix Alpine Update Failed">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="http://www.recall704.com/cloud/k8s-node-roles/" data-toggle="tooltip" data-placement="top" title="k8s 中 node 的 roles">Next Post &rarr;</a>
          </li>
        
      </ul>

      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
          
          &nbsp;&bull;&nbsp;
          2018

          
            &nbsp;&bull;&nbsp;
            <a href="http://www.recall704.com/">RECALL&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.32.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="http://www.recall704.com/js/main.js"></script>
<script src="http://www.recall704.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="http://www.recall704.com/js/load-photoswipe.js"></script>



  </body>
</html>

