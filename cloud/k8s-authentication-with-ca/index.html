<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>创建 client （二）： 通过配置文件方式访问 k8s API</title>
  <meta property="og:title" content="创建 client （二）： 通过配置文件方式访问 k8s API" />
  <meta name="twitter:title" content="创建 client （二）： 通过配置文件方式访问 k8s API" />
  <meta name="description" content="0x01 概述 前面我讲过集群内通过 ServiceAccount 生成 token 的方式访问 k8s API Server， 那么如果我们要访问 k8s api 的应用不是跑在 k8s 之内，而是在 k8s 集群之外运行呢？
这个时候，我们还有两种认证方式
 ca 证书认证
 basic 认证  0x02 kubectl 是如何访问 k8s 的？ k8s 部署的时候，我们会给 kubectl 配置证书，context 等信息，生成一个 $HOME/.kube/config 这样的文件，文件内容如下 apiVersion: v1 clusters: - cluster: certificate-authority-data: ... server: https://192.168.1.200:6443 name: kube_cluster contexts: - context: cluster: kube_cluster namespace: kube-system user: kubectl name: kubectl@kube_cluster current-context: kubectl@kube_cluster kind: Config preferences: {} users: - name: kubectl user: as-user-extra: {} client-certificate-data: .">
  <meta property="og:description" content="0x01 概述 前面我讲过集群内通过 ServiceAccount 生成 token 的方式访问 k8s API Server， 那么如果我们要访问 k8s api 的应用不是跑在 k8s 之内，而是在 k8s 集群之外运行呢？
这个时候，我们还有两种认证方式
 ca 证书认证
 basic 认证  0x02 kubectl 是如何访问 k8s 的？ k8s 部署的时候，我们会给 kubectl 配置证书，context 等信息，生成一个 $HOME/.kube/config 这样的文件，文件内容如下 apiVersion: v1 clusters: - cluster: certificate-authority-data: ... server: https://192.168.1.200:6443 name: kube_cluster contexts: - context: cluster: kube_cluster namespace: kube-system user: kubectl name: kubectl@kube_cluster current-context: kubectl@kube_cluster kind: Config preferences: {} users: - name: kubectl user: as-user-extra: {} client-certificate-data: .">
  <meta name="twitter:description" content="0x01 概述 前面我讲过集群内通过 ServiceAccount 生成 token 的方式访问 k8s API Server， 那么如果我们要访问 k8s api 的应用不是跑在 k8s 之内，而是在 k8s 集群之外运行呢？
这个时候，我们还有两种认证方式
 ca 证书认证
 basic 认证  0x02 kubectl 是如何访问 k8s 的？ k8s 部署的时候，我们会给 kubectl  …">
  <meta name="author" content=""/>
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="http://www.recall704.com/cloud/k8s-authentication-with-ca/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="RECALL&#39;s Blog" />

  <meta name="generator" content="Hugo 0.32.2" />
  <link rel="canonical" href="http://www.recall704.com/cloud/k8s-authentication-with-ca/" />
  <link rel="alternate" href="http://www.recall704.com/index.xml" type="application/rss+xml" title="RECALL&#39;s Blog">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://www.recall704.com/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://www.recall704.com/css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://www.recall704.com/css/highlight.min.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.recall704.com/">RECALL&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="home" href="/">home</a>
            </li>
          
        
          
            <li>
              <a title="tags" href="/tags/">tags</a>
            </li>
          
        
          
            <li>
              <a title="categories" href="/categories/">categories</a>
            </li>
          
        
          
            <li>
              <a title="series" href="/series/">series</a>
            </li>
          
        
          
            <li>
              <a title="about" href="/about/">about</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-sm-10 col-xs-10">
            <div class="post-heading">
              <h1>创建 client （二）： 通过配置文件方式访问 k8s API</h1>
                
                
                  <span class="post-meta">
  Posted on April 15, 2018
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-sm-10 col-xs-10">

      

      <article role="main" class="blog-post">
        

<h1 id="0x01-概述">0x01 概述</h1>

<p>前面我讲过集群内通过 ServiceAccount 生成 token 的方式访问 k8s API Server，
那么如果我们要访问 k8s api 的应用不是跑在 k8s 之内，而是在 k8s 集群之外运行呢？</p>

<p>这个时候，我们还有两种认证方式</p>

<ul>
<li>ca 证书认证<br /></li>
<li>basic 认证</li>
</ul>

<h1 id="0x02-kubectl-是如何访问-k8s-的">0x02 kubectl 是如何访问 k8s 的？</h1>

<p>k8s 部署的时候，我们会给 kubectl 配置证书，context 等信息，生成一个 <code>$HOME/.kube/config</code> 这样的文件，文件内容如下 </p>

<pre><code class="language-yaml">apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: ...
    server: https://192.168.1.200:6443
  name: kube_cluster
contexts:
- context:
    cluster: kube_cluster
    namespace: kube-system
    user: kubectl
  name: kubectl@kube_cluster
current-context: kubectl@kube_cluster
kind: Config
preferences: {}
users:
- name: kubectl
  user:
    as-user-extra: {}
    client-certificate-data: ...
    client-key-data: ...
</code></pre>

<p>这个配置文件主要包括了两个部分：</p>

<ol>
<li>apiserver 的信息</li>
<li>ca 证书信息</li>
</ol>

<h1 id="0x03-通过-ca-证书访问-k8s">0x03 通过 ca 证书访问 k8s</h1>

<p>我们可以参考 kubectl ，通过配置文件，创建对应的 client</p>

<pre><code class="language-go">func main() {
	var kubeconfig *string
	if home := homeDir(); home != &quot;&quot; {
		kubeconfig = flag.String(&quot;kubeconfig&quot;, filepath.Join(home, &quot;.kube&quot;, &quot;config&quot;), &quot;(optional) absolute path to the kubeconfig file&quot;)
	} else {
		kubeconfig = flag.String(&quot;kubeconfig&quot;, &quot;&quot;, &quot;absolute path to the kubeconfig file&quot;)
	}
	flag.Parse()

	// use the current context in kubeconfig
	config, err := clientcmd.BuildConfigFromFlags(&quot;&quot;, *kubeconfig)
	if err != nil {
		panic(err.Error())
	}

	// create the clientset
	clientset, err := kubernetes.NewForConfig(config)
	if err != nil {
		panic(err.Error())
	}
    ...
}
</code></pre>

<p>这里我们深入了解一下</p>

<pre><code class="language-go">func BuildConfigFromFlags(masterUrl, kubeconfigPath string) (*restclient.Config, error) {
	if kubeconfigPath == &quot;&quot; &amp;&amp; masterUrl == &quot;&quot; {
		glog.Warningf(&quot;Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.&quot;)
		kubeconfig, err := restclient.InClusterConfig()
		if err == nil {
			return kubeconfig, nil
		}
		glog.Warning(&quot;error creating inClusterConfig, falling back to default config: &quot;, err)
	}
	return NewNonInteractiveDeferredLoadingClientConfig(
		&amp;ClientConfigLoadingRules{ExplicitPath: kubeconfigPath},
		&amp;ConfigOverrides{ClusterInfo: clientcmdapi.Cluster{Server: masterUrl}}).ClientConfig()
}
</code></pre>

<p>如果没有指定 kubeconfig 路径，会尝试通过 InclusterConfig 的方式连接 apiserver。</p>

<h1 id="0x04-通过自定义方式连接-apiserver">0x04 通过自定义方式连接 apiserver</h1>

<p>如果不是一个 kubeconfig 文件，我们能不能自己配置访问 apiserver 呢？
答案是可以的</p>

<pre><code class="language-go">var clientConfig clientcmd.ClientConfig
clientConfig = clientcmd.NewNonInteractiveDeferredLoadingClientConfig(
	&amp;clientcmd.ClientConfigLoadingRules{ExplicitPath: &quot;&quot;},
	&amp;clientcmd.ConfigOverrides{
		ClusterInfo: clientcmdapi.Cluster{
            Server:               &quot;https://192.168.1.200:6443&quot;,
			CertificateAuthority: &quot;ca.crt&quot;,
		},
		AuthInfo: clientcmdapi.AuthInfo{
			ClientCertificate: &quot;client.crt&quot;,
			ClientKey:         &quot;client.key&quot;,
		},
	})
cfg, err := clientConfig.ClientConfig()
</code></pre>

<p>在 ClusterInfo 中写入 apiserver 的信息，<br />
在 AuthInfo 写入 认证的证书信息，我们就能创建好这个配置文件了。</p>

      </article>



      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="http://www.recall704.com/cloud/k8s-operator/" data-toggle="tooltip" data-placement="top" title="k8s operator 简介">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="http://www.recall704.com/cloud/k8s-authentication-with-basic/" data-toggle="tooltip" data-placement="top" title="创建 client （三）： HTTP Basic Auth 访问 k8s API Server">Next Post &rarr;</a>
          </li>
        
      </ul>

      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
          
          &nbsp;&bull;&nbsp;
          2018

          
            &nbsp;&bull;&nbsp;
            <a href="http://www.recall704.com/">RECALL&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.32.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="http://www.recall704.com/js/main.js"></script>
<script src="http://www.recall704.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="http://www.recall704.com/js/load-photoswipe.js"></script>



  </body>
</html>

